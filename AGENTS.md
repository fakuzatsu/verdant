<!--
AI-PARSE-MODE: DOCUMENTATION
DOMAIN: Game Development / Embedded C
PARSING-FOCUS:
  - Scripting API (event.inc, specials.inc)
  - Battle/Field Systems (src/)
  - Save Data (save.v-current.h)
-->

# Repository Overview

This repository contains the source code for the **pokeemerald-expansion** project.
Much of the gameplay code is written in C, while data files and event logic
make heavy use of a custom assembly-like `.inc` format. The important folders
are:

- `src/` – C source files for the engine, battle system, and field system.
- `include/` - C header files for exporting functions and data across the repo.
- `include/constants/` - C header files for constant data also used in scripts.
- `data/` – scripts, maps, and other data in `.inc` or `.json` form.
- `asm/` – shared macros used by the `.inc` scripts.

## Important notice:
This game runs on the Nintendo Gameboy Advance.
Consequentially there are limitations in how we approach particular challenges,
as noted below:

- The cartridge (ROM) can only contain limited information. Additionally, the
  Gameboy itself only has a limited amount of RAM, as noted below:
    - ROM space: Limited to 32mb. 
      Note that the transfers to and from ROM are all 16 bits wide.
    - EWRAM space: Limited to 256kb. 
      EWRAM Memory transfers are 16 bits wide and consume more cycles than IWRAM.
    - IWRAM space: Limited to 32kb. 
      It is the fastest of all the GBA's RAM with a 32 bit bus.
- The Gameboy itself contains only a limited BIOS, with few accessible functions. 
  As such, popular packages like stdio are not available unless programmed into
  the cartridge manually.

Below is a brief tour of the key areas so Codex can understand where to look
when modifying or referencing different systems.


## src

The `src` directory holds the bulk of the game logic. Notable components
include:

- **Battle system** – `battle_controller_*.c` files handle various types of 
  battle behaviour. Providing functions for various event generated by the 
  player, link partner/opponent or AI.
  While `battle_main.c` drives the overall battle flow.
- **Field system** – files like `field_camera.c` and `field_control_avatar.c`
  manage overworld movement and camera logic associated with the player.
- **Field specials** – `field_specials.c` implements many of the functions
  triggered by the event system (`specials.inc`), and `scrcmd.c` links script
  commands (`event.inc`) to C functions.


## data
Game data and scripts reside in the `data` folder. Important subfolders are:

- `maps/` – each map has a `map.json` file describing layout and events. These
  JSON files are converted into `.inc` scripts using
  `tools/mapjson/mapjson.cpp` together with macros from `asm/macros/map.inc`.
- `scripts/` – event scripts written in the custom `.inc` language. These use
  macros defined in `asm/macros/event.inc` for flow control and calls to C
  specials. Each map also has its own `scripts.inc` file for organisation.
- `text/` – dialogue and other strings, also stored as `.inc` files.
- `specials.inc` – table of event "special" functions that map to C
  implementations, primarily in `src/field_specials.c`.
- `event.inc` - table of event "macros" that map to C implementations, primarily
  in `src/scrcmd.c`. These differ from specials primarily in that they accept
  input which is passed to the C functions they are mapped to.
- `event_scripts.s` includes all of the constant files required for scripts, and
  defines common scripts utilized across other files.

Many `.inc` files reference macros from `asm/macros/` to build structured data
without writing raw assembly.


## The `.inc` Event Language
The project uses a custom assembly-style scripting language for events. Scripts
are assembled with the macros in `asm/macros/event.inc` and specials in
`data/specials.inc`. A script might look like:

```asm
ScriptLabel
lock
faceplayer
goto_if_set FLAG_EXAMPLE, SomeOtherScriptLabel
end
```

Macros expand to the correct bytecode for the engine. Script files often call
`special` functions listed in `data/specials.inc`. Those specials point to C
functions such as `DoPCTurnOnEffect` in `src/field_specials.c`.


## Flags, Vars, and Save Data
Game progress is stored in three structs defined in `include/save.v-current.h`:
`SaveBlock1`, `SaveBlock2`, and `SaveBlock3`. Pointers named
`gSaveBlock1Ptr`, `gSaveBlock2Ptr`, and `gSaveBlock3Ptr` give access to the
current save data. Within `SaveBlock1` reside arrays for flags and vars:
`u8 flags[NUM_FLAG_BYTES]` and `u16 vars[VARS_COUNT]`.

Flags and variables have symbolic IDs declared in
`include/constants/flags.h` and `include/constants/vars.h`. Event scripts use
macros like `setflag`, `setvar`, `goto_if_set`, and `goto_if_eq` from
`asm/macros/event.inc` to manipulate them. In C, helper functions such as
`FlagSet`, `FlagClear`, `VarSet`, and `VarGet` in `src/event_data.c` perform the
same operations. This system allows scripts and code to check prior actions and
branch accordingly.

> For game mechanics in C that do not need to interface with the scripting language,
> the saveblock should be utilized directly by creating new elements in it, rather
> than utilizing flags and constants. However, saveblock is incredibly limited and
> it's usage should be kept to a minimum.
